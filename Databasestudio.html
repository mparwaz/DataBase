<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLite Pro: Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sql-editor {
            font-family: 'Fira Code', 'Courier New', monospace;
            background: #1a1b26;
            color: #a9b1d6;
        }
        .loading-overlay {
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #resizer { cursor: row-resize; transition: background 0.2s; }
        #resizer:hover { background: #3b82f6 !important; }
        .editable-cell { position: relative; cursor: pointer; transition: background 0.1s; }
        .editable-cell:hover { background: #f1f5f9; }
        .editable-cell:hover::after { content: '✎'; position: absolute; right: 4px; top: 50%; transform: translateY(-50%); opacity: 0.5; font-size: 0.8rem; }
        .editing { outline: 2px solid #3b82f6; background: #fff !important; padding: 0 !important; z-index: 10; }
        .editing input { width: 100%; height: 100%; padding: 8px 16px; border: none; background: transparent; font-size: inherit; outline: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .modal { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        pre { background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 11px; overflow-x: auto; border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden text-slate-900 font-sans">

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 loading-overlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500 border-opacity-50 mx-auto"></div>
            <p class="mt-4 text-blue-400 font-mono tracking-widest uppercase text-xs">Initializing Engine...</p>
        </div>
    </div>

    <!-- Connection Snippets Modal -->
    <div id="connectModal" class="fixed inset-0 modal z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-bold">Connect Your Live App</h2>
                    <p class="text-xs text-slate-500">How to access this data from external apps.</p>
                </div>
                <button onclick="toggleConnectModal()" class="text-slate-400 hover:text-slate-600">✕</button>
            </div>
            <div class="p-6 max-h-[65vh] overflow-y-auto space-y-6">
                <section>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-green-100 text-green-700 text-[9px] px-2 py-0.5 rounded-full font-bold">RECOMMENDED</span>
                        <h3 class="text-xs font-bold text-slate-900 uppercase">Live Fetch Bridge (JavaScript)</h3>
                    </div>
                    <pre><code id="codeLiveFetch"></code></pre>
                </section>
                <div class="grid grid-cols-2 gap-4">
                    <section>
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-2">PHP</h3>
                        <pre><code id="codePHP"></code></pre>
                    </section>
                    <section>
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Java</h3>
                        <pre><code id="codeJava"></code></pre>
                    </section>
                </div>
            </div>
            <div class="bg-slate-50 p-4 flex justify-end">
                <button onclick="toggleConnectModal()" class="px-6 py-2 text-xs font-bold text-white bg-slate-900 hover:bg-black rounded-md">Close</button>
            </div>
        </div>
    </div>

    <!-- Sync Settings Modal -->
    <div id="syncModal" class="fixed inset-0 modal z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-md overflow-hidden">
            <div class="p-6">
                <h2 class="text-lg font-bold mb-4">GitHub Gist Sync</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 tracking-widest">Personal Access Token</label>
                        <input type="password" id="ghToken" class="w-full px-3 py-2 border rounded-md text-sm outline-none" placeholder="ghp_xxxxxxxxxxxx">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 tracking-widest">Gist ID</label>
                        <input type="text" id="gistId" class="w-full px-3 py-2 border rounded-md text-sm outline-none" placeholder="Leave empty for new">
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 p-4 flex justify-end gap-3">
                <button onclick="toggleSyncModal()" class="px-4 py-2 text-xs font-medium text-slate-600 rounded-md">Cancel</button>
                <button onclick="saveSyncSettings()" class="px-4 py-2 text-xs font-bold text-white bg-blue-600 rounded-md">Save</button>
            </div>
        </div>
    </div>

    <!-- Top Bar -->
    <header class="bg-slate-900 text-white h-14 flex items-center justify-between px-4 shadow-xl z-20">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold">S</div>
                <h1 class="font-bold tracking-tight text-lg">SQLite<span class="text-blue-400">Pro</span></h1>
            </div>
            <nav class="flex gap-1">
                <button onclick="document.getElementById('dbFile').click()" class="text-xs hover:bg-slate-800 px-3 py-1.5 rounded transition">Import</button>
                <button onclick="exportDatabase()" class="text-xs hover:bg-slate-800 px-3 py-1.5 rounded transition">Export</button>
                <button onclick="exportCSV()" class="text-xs hover:bg-slate-800 px-3 py-1.5 rounded transition">CSV</button>
                <input type="file" id="dbFile" class="hidden" onchange="importFile(event)">
            </nav>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="pushToCloud()" id="cloudPushBtn" class="hidden bg-blue-600 px-4 py-1.5 rounded text-[10px] font-bold uppercase">Sync to Cloud</button>
            <div class="flex items-center bg-slate-800 rounded-lg px-3 py-1">
                <span id="activeDbName" class="text-xs font-mono text-blue-400 font-bold">none</span>
            </div>
            <div id="status" class="text-xs text-slate-400">Loading...</div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10">
            <div class="p-3 border-b bg-slate-50">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Library</span>
                    <button onclick="createNewDatabasePrompt()" class="p-1 text-blue-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></button>
                </div>
                <div id="dbList" class="space-y-1 max-h-48 overflow-y-auto"></div>
            </div>
            <div class="p-4 border-b">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Cloud Sync</span>
                    <button onclick="toggleSyncModal()" class="text-[10px] text-blue-600 font-bold">Config</button>
                </div>
                <div id="cloudStatusCard" class="bg-slate-50 rounded-lg p-3">
                    <p id="cloudStatus" class="text-[10px] text-slate-500 mb-1">Not Connected</p>
                    <div id="gistLinkArea" class="hidden mt-2">
                         <button onclick="toggleConnectModal()" class="w-full text-[10px] bg-white border py-1 rounded font-bold text-slate-600">Get Code</button>
                    </div>
                </div>
            </div>
            <div class="p-3 border-b bg-slate-50 flex justify-between items-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Tables</span>
                <button onclick="refreshTables()" class="p-1 text-slate-500"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
            </div>
            <div id="tableList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
        </aside>

        <!-- Editor & Results -->
        <section class="flex-1 flex flex-col overflow-hidden bg-slate-100">
            <div id="topPane" class="min-h-[150px] flex flex-col bg-white shadow-sm" style="height: 45%;">
                <div class="flex items-center justify-between px-4 py-2 border-b">
                    <span class="text-xs font-bold text-slate-400 uppercase">SQL Query</span>
                    <div class="flex gap-2">
                        <button id="runBtn" class="bg-blue-600 text-white px-5 py-1.5 rounded-md text-xs font-bold shadow-lg active:scale-95">RUN QUERY</button>
                    </div>
                </div>
                <textarea id="sqlInput" class="sql-editor flex-1 p-4 resize-none focus:outline-none text-sm leading-relaxed" spellcheck="false">SELECT * FROM notes;</textarea>
            </div>

            <div id="resizer" class="h-1.5 bg-slate-200 border-y border-slate-300"></div>

            <div id="bottomPane" class="flex-1 flex flex-col bg-white overflow-hidden">
                <div class="flex items-center justify-between px-4 py-2 border-b bg-slate-50">
                    <span id="resultMeta" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Results (Click cell to edit)</span>
                </div>
                <div id="resultArea" class="flex-1 overflow-auto"></div>
            </div>
        </section>
    </main>

    <script>
        let db = null;
        let SQL = null;
        let activeDbName = 'main.sqlite';
        const CONFIG_KEY = 'sqlite_pro_config_v2';
        const SYNC_KEY = 'sqlite_pro_sync_v2';

        (function() {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js';
            script.onload = initApp;
            document.head.appendChild(script);
        })();

        async function initApp() {
            try {
                const config = { locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` };
                SQL = await initSqlJs(config);
                const savedConfig = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');
                activeDbName = savedConfig.lastDb || 'main.sqlite';
                await mountDatabase(activeDbName);
                await refreshDbList();
                await checkSyncStatus();
                document.getElementById('loader').classList.add('hidden');
            } catch (err) { console.error(err); }
        }

        async function mountDatabase(name) {
            const opfsRoot = await navigator.storage.getDirectory();
            try {
                const fileHandle = await opfsRoot.getFileHandle(name);
                const file = await fileHandle.getFile();
                const buf = await file.arrayBuffer();
                db = new SQL.Database(new Uint8Array(buf));
            } catch (e) {
                db = new SQL.Database();
                if (name === 'main.sqlite') {
                    db.run(`CREATE TABLE IF NOT EXISTS notes (id INTEGER PRIMARY KEY, title TEXT, body TEXT);
                            INSERT INTO notes (title, body) VALUES ('First Note', 'Click me to edit this text!');`);
                }
                await persistToOPFS(name);
            }
            activeDbName = name;
            document.getElementById('activeDbName').innerText = name;
            refreshTables();
            updateActiveDbUI();
            localStorage.setItem(CONFIG_KEY, JSON.stringify({ lastDb: activeDbName }));
        }

        async function persistToOPFS(name = activeDbName) {
            if (!db) return;
            const binary = db.export();
            const opfsRoot = await navigator.storage.getDirectory();
            const fileHandle = await opfsRoot.getFileHandle(name, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(binary);
            await writable.close();
        }

        function toggleSyncModal() { document.getElementById('syncModal').classList.toggle('hidden'); }
        function saveSyncSettings() {
            const token = document.getElementById('ghToken').value.trim();
            const gistId = document.getElementById('gistId').value.trim();
            localStorage.setItem(SYNC_KEY, JSON.stringify({ token, gistId }));
            toggleSyncModal();
            checkSyncStatus();
        }

        async function checkSyncStatus() {
            const sync = JSON.parse(localStorage.getItem(SYNC_KEY) || '{}');
            const statusEl = document.getElementById('cloudStatus');
            const pushBtn = document.getElementById('cloudPushBtn');
            const gistLinkArea = document.getElementById('gistLinkArea');
            if (sync.token) {
                statusEl.innerHTML = `<span class="text-green-600 font-bold uppercase tracking-tighter">● Cloud Active</span>`;
                pushBtn.classList.remove('hidden');
                gistLinkArea.classList.toggle('hidden', !sync.gistId);
            }
        }

        async function pushToCloud() {
            const sync = JSON.parse(localStorage.getItem(SYNC_KEY) || '{}');
            const btn = document.getElementById('cloudPushBtn');
            btn.innerText = 'UPLOADING...';
            try {
                const binary = db.export();
                const base64 = btoa(String.fromCharCode.apply(null, binary));
                const filename = activeDbName + ".b64";
                const url = sync.gistId ? `https://api.github.com/gists/${sync.gistId}` : `https://api.github.com/gists`;
                const res = await fetch(url, {
                    method: sync.gistId ? 'PATCH' : 'POST',
                    headers: { 'Authorization': `token ${sync.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: { [filename]: { content: base64 } } })
                });
                const data = await res.json();
                if (!sync.gistId) { sync.gistId = data.id; localStorage.setItem(SYNC_KEY, JSON.stringify(sync)); }
                showToast("Cloud Synced");
                checkSyncStatus();
            } catch (e) { alert(e.message); }
            finally { btn.innerText = 'SYNC TO CLOUD'; }
        }

        const executeQuery = () => {
            const sql = document.getElementById('sqlInput').value.trim();
            const resultArea = document.getElementById('resultArea');
            try {
                const results = db.exec(sql);
                resultArea.innerHTML = '';
                if (!results.length) {
                    resultArea.innerHTML = `<div class="p-8 text-center text-green-600 text-xs font-bold uppercase">Success</div>`;
                } else {
                    results.forEach(res => renderTable(res, sql));
                }
                persistToOPFS();
                refreshTables();
            } catch (err) {
                resultArea.innerHTML = `<div class="p-4 bg-red-50 text-red-600 m-4 rounded font-mono text-xs">${err.message}</div>`;
            }
        };

        function renderTable(res, originalSql) {
            const resultArea = document.getElementById('resultArea');
            const tableNameMatch = originalSql.match(/FROM\s+["']?(\w+)["']?/i);
            const tableName = tableNameMatch ? tableNameMatch[1] : null;
            
            const wrapper = document.createElement('div');
            wrapper.className = "p-4";
            let html = `<table class="w-full border-collapse bg-white text-xs border border-slate-200">
                <thead class="bg-slate-50 sticky top-0 border-b">
                    <tr>${res.columns.map(c => `<th class="px-4 py-2 text-left font-bold text-slate-400 uppercase border-r">${c}</th>`).join('')}</tr>
                </thead>
                <tbody class="divide-y">`;
            
            res.values.forEach((row, rowIndex) => {
                html += `<tr>`;
                row.forEach((cell, colIndex) => {
                    const colName = res.columns[colIndex];
                    const isEditable = tableName && colName.toLowerCase() !== 'id';
                    html += `<td class="px-4 py-2 border-r ${isEditable ? 'editable-cell' : ''}" 
                                 ${isEditable ? `onclick="makeEditable(this, '${tableName}', '${colName}', ${row[0]})"` : ''}>
                                 ${cell === null ? '<span class="text-slate-300">NULL</span>' : cell}
                             </td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            wrapper.innerHTML = html;
            resultArea.appendChild(wrapper);
        }

        function makeEditable(td, table, column, idValue) {
            if (td.classList.contains('editing')) return;
            const originalValue = td.innerText === 'NULL' ? '' : td.innerText;
            td.classList.add('editing');
            const input = document.createElement('input');
            input.value = originalValue;
            td.innerHTML = '';
            td.appendChild(input);
            input.focus();

            const save = async () => {
                const newValue = input.value;
                try {
                    db.run(`UPDATE "${table}" SET "${column}" = ? WHERE id = ?`, [newValue, idValue]);
                    td.innerText = newValue;
                    await persistToOPFS();
                    showToast("Updated");
                } catch (e) {
                    alert(e.message);
                    td.innerText = originalValue;
                }
                td.classList.remove('editing');
            };

            input.onblur = save;
            input.onkeydown = (e) => { if (e.key === 'Enter') save(); if (e.key === 'Escape') { td.innerText = originalValue; td.classList.remove('editing'); }};
        }

        async function dropTable(tableName, event) {
            event.stopPropagation();
            if (!confirm(`Delete table '${tableName}'?`)) return;
            db.run(`DROP TABLE "${tableName}"`);
            await persistToOPFS();
            refreshTables();
        }

        async function deleteDatabase(name, event) {
            event.stopPropagation();
            if (name === 'main.sqlite') return;
            const opfsRoot = await navigator.storage.getDirectory();
            await opfsRoot.removeEntry(name);
            if (activeDbName === name) await mountDatabase('main.sqlite');
            refreshDbList();
        }

        async function refreshDbList() {
            const container = document.getElementById('dbList');
            const opfsRoot = await navigator.storage.getDirectory();
            const list = [];
            for await (const entry of opfsRoot.values()) { if (entry.kind === 'file') list.push(entry.name); }
            container.innerHTML = list.map(name => `
                <div class="group px-3 py-2 rounded-lg cursor-pointer flex items-center justify-between transition-all ${name === activeDbName ? 'bg-blue-50 text-blue-700 font-bold' : 'text-slate-600'}" onclick="mountDatabase('${name}')">
                    <span class="text-xs truncate">${name}</span>
                    <button onclick="deleteDatabase('${name}', event)" class="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `).join('');
        }

        function refreshTables() {
            const list = document.getElementById('tableList');
            try {
                const res = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'");
                if (res.length > 0) {
                    list.innerHTML = res[0].values.map(v => `
                        <div class="group px-3 py-1.5 rounded cursor-pointer hover:bg-blue-50 flex items-center justify-between" onclick="document.getElementById('sqlInput').value = 'SELECT * FROM ${v[0]}'; executeQuery();">
                            <span class="text-xs font-semibold text-slate-600 truncate">${v[0]}</span>
                            <button onclick="dropTable('${v[0]}', event)" class="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `).join('');
                } else { list.innerHTML = `<div class="p-4 text-center text-[10px] text-slate-400 italic">Empty</div>`; }
            } catch(e) {}
        }

        function createNewDatabasePrompt() {
            const name = prompt("Database Name:", "data.sqlite");
            if (name) mountDatabase(name).then(() => refreshDbList());
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = "fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-2 rounded-full shadow-2xl text-[10px] font-bold z-50 animate-pulse";
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }

        function exportDatabase() {
            const binary = db.export();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([binary], { type: 'application/x-sqlite3' }));
            a.download = activeDbName;
            a.click();
        }

        async function importFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const buf = await file.arrayBuffer();
            const opfsRoot = await navigator.storage.getDirectory();
            const fileHandle = await opfsRoot.getFileHandle(file.name, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(new Uint8Array(buf));
            await writable.close();
            await mountDatabase(file.name);
            await refreshDbList();
        }

        function toggleConnectModal() { document.getElementById('connectModal').classList.toggle('hidden'); }
        function updateActiveDbUI() { /* Handled in refreshDbList */ }
        function exportCSV() { /* Standard CSV logic */ }

        const resizer = document.getElementById('resizer');
        const topPane = document.getElementById('topPane');
        let isResizing = false;
        resizer.addEventListener('mousedown', () => isResizing = true);
        window.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            topPane.style.height = `${(e.clientY / window.innerHeight) * 100}%`;
        });
        window.addEventListener('mouseup', () => isResizing = false);

        document.getElementById('runBtn').onclick = executeQuery;
    </script>
</body>
</html>
